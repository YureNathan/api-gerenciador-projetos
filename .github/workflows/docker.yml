name: CI/CD Docker build and Test

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: âœ… Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Definir tag da imagem
        run: |
          # Define a tag da imagem e a exporta para os prÃ³ximos passos
          # Isso garante que seu docker-compose.yml usarÃ¡ a imagem correta
          echo "DOCKER_IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/gerenciador_projeto:latest" >> $GITHUB_ENV

      - name: ğŸš€ Buildar e carregar imagem localmente
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_TAG }}

      - name: ğŸ‹ Subir ambiente com Docker Compose (para teste)

        run: docker compose up -d

      - name: ğŸ©º Verificar status dos contÃªineres pÃ³s-healthcheck
        run: |
          echo "Ambiente iniciado. Verificando status..."
          docker compose ps
          
          echo "--- Logs do Banco de Dados (postgres-db) ---"
          docker compose logs postgres-db
          
          echo "--- Logs da API (api-spring) ---"
          docker compose logs api-spring

 

      - name: ğŸš€ Fazer Push da imagem para o Docker Hub
        if: success()
        run: docker push ${{ env.DOCKER_IMAGE_TAG }}

      - name: ğŸ›‘ Parar os contÃªineres
        if: always()
        run: docker compose down